# Диаграммы классов и зависимости

## Диаграмма зависимостей слоев

```
┌─────────────────────────────────────────────────────────┐
│              Presentation Layer (WPF)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ ViewModels   │  │    Views     │  │   Services   │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
└─────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
┌────────────────────────────┼────────────────────────────┐
│         Application Layer  │                            │
│  ┌──────────────┐  ┌───────┴───────┐  ┌──────────────┐ │
│  │  Use Cases   │  │    Services   │  │     DTOs     │ │
│  └──────┬───────┘  └───────┬───────┘  └──────────────┘ │
└─────────┼──────────────────┼────────────────────────────┘
          │                  │
          └──────────────────┘
                             │
┌────────────────────────────┼────────────────────────────┐
│         Domain Layer       │                            │
│  ┌──────────────┐  ┌───────┴───────┐  ┌──────────────┐ │
│  │  Entities    │  │  Interfaces   │  │    Enums     │ │
│  └──────────────┘  └───────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────┐
│      Infrastructure Layer  │                            │
│  ┌──────────────┐  ┌───────┴───────┐  ┌──────────────┐ │
│  │ Repositories │  │ External APIs │  │ File System  │ │
│  └──────────────┘  └───────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────┐
│         Core Layer         │                            │
│  ┌──────────────┐  ┌───────┴───────┐  ┌──────────────┐ │
│  │   Helpers    │  │  Extensions   │  │  Exceptions  │ │
│  └──────────────┘  └───────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**Правило зависимостей**: Зависимости направлены внутрь. Внешние слои зависят от внутренних, но не наоборот.

---

## Диаграмма классов: Domain Layer

### Entities

```
┌─────────────────────────────────────┐
│            Meeting                  │
├─────────────────────────────────────┤
│ + Id: Guid                          │
│ + StartTime: DateTime               │
│ + EndTime: DateTime?                │
│ + Status: MeetingStatus             │
│ + Recording: MeetingRecording       │
│ + Report: MeetingReport?            │
├─────────────────────────────────────┤
│ + Start()                           │
│ + Stop()                            │
│ + GetDuration(): TimeSpan           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│        MeetingRecording             │
├─────────────────────────────────────┤
│ + Id: Guid                          │
│ + FilePath: string                  │
│ + Duration: TimeSpan                │
│ + CreatedAt: DateTime               │
│ + Format: string                    │
├─────────────────────────────────────┤
│ + GetFileSize(): long               │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         MeetingReport               │
├─────────────────────────────────────┤
│ + Id: Guid                          │
│ + MeetingId: Guid                   │
│ + Content: string                   │
│ + Language: Language                │
│ + CreatedAt: DateTime               │
│ + TemplateId: Guid?                 │
├─────────────────────────────────────┤
│ + Export(format: string): byte[]    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      TranslationRequest             │
├─────────────────────────────────────┤
│ + Id: Guid                          │
│ + OriginalText: string              │
│ + SourceLanguage: Language          │
│ + TargetLanguage: Language          │
│ + AudioSource: AudioSource          │
│ + Timestamp: DateTime               │
├─────────────────────────────────────┤
│ + IsValid(): bool                   │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       TranslationResult             │
├─────────────────────────────────────┤
│ + RequestId: Guid                   │
│ + OriginalText: string              │
│ + TranslatedText: string            │
│ + SourceLanguage: Language          │
│ + TargetLanguage: Language          │
│ + ProcessingTime: TimeSpan          │
└─────────────────────────────────────┘
```

### Interfaces (Repository Pattern)

```
┌─────────────────────────────────────┐
│      IMeetingRepository             │
├─────────────────────────────────────┤
│ + GetById(id: Guid): Meeting?       │
│ + GetAll(): IEnumerable<Meeting>    │
│ + Add(meeting: Meeting): void       │
│ + Update(meeting: Meeting): void    │
│ + Delete(id: Guid): void            │
└─────────────────────────────────────┘
              ▲
              │ implements
              │
┌─────────────────────────────────────┐
│      MeetingRepository              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│     IRecordingRepository            │
├─────────────────────────────────────┤
│ + Save(recording: MeetingRecording) │
│ + GetByMeetingId(id: Guid)          │
│ + Delete(id: Guid)                  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      IReportRepository              │
├─────────────────────────────────────┤
│ + Save(report: MeetingReport)       │
│ + GetByMeetingId(id: Guid)          │
│ + GetAll(): IEnumerable<Report>     │
└─────────────────────────────────────┘
```

---

## Диаграмма классов: Application Layer

### Use Cases

```
┌─────────────────────────────────────┐
│    StartMeetingUseCase              │
├─────────────────────────────────────┤
│ - meetingService: IMeetingService   │
│ - audioRecorder: IAudioRecorder     │
├─────────────────────────────────────┤
│ + ExecuteAsync(): Task<Meeting>     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│    StopMeetingUseCase               │
├─────────────────────────────────────┤
│ - meetingService: IMeetingService   │
│ - audioRecorder: IAudioRecorder     │
├─────────────────────────────────────┤
│ + ExecuteAsync(meetingId: Guid)     │
│   : Task<MeetingRecording>          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ProcessMeetingRecordingUseCase      │
├─────────────────────────────────────┤
│ - openAIClient: IOpenAIClient       │
│ - reportService: IReportService     │
├─────────────────────────────────────┤
│ + ExecuteAsync(recordingId: Guid)   │
│   : Task<MeetingReport>             │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  ListenToInterlocutorUseCase        │
├─────────────────────────────────────┤
│ - audioCapture: IAudioCapture       │
│ - translationService: ITranslation  │
├─────────────────────────────────────┤
│ + ExecuteAsync(): Task<Translation> │
└─────────────────────────────────────┘
```

### Services

```
┌─────────────────────────────────────┐
│      IMeetingService                │
├─────────────────────────────────────┤
│ + StartMeetingAsync(): Task<Meeting>│
│ + StopMeetingAsync(id): Task        │
│ + GetMeetingAsync(id): Task<Meeting>│
└─────────────────────────────────────┘
              ▲
              │ implements
              │
┌─────────────────────────────────────┐
│       MeetingService                │
├─────────────────────────────────────┤
│ - meetingRepo: IMeetingRepository   │
│ - recordingRepo: IRecordingRepo     │
│ - audioRecorder: IAudioRecorder     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│    ITranslationService              │
├─────────────────────────────────────┤
│ + TranslateAsync(request)           │
│   : Task<TranslationResult>         │
│ + ListenAndTranslateAsync(source)   │
│   : IAsyncEnumerable<Translation>   │
└─────────────────────────────────────┘
```

---

## Диаграмма классов: Infrastructure Layer

### External Services

```
┌─────────────────────────────────────┐
│       IOpenAIClient                 │
├─────────────────────────────────────┤
│ + TranscribeAsync(audio): Task      │
│ + TranslateAsync(text): Task        │
│ + GenerateReportAsync(prompt): Task │
└─────────────────────────────────────┘
              ▲
              │ implements
              │
┌─────────────────────────────────────┐
│        OpenAIClient                 │
├─────────────────────────────────────┤
│ - httpClient: HttpClient            │
│ - apiKey: string                    │
│ - baseUrl: string                   │
├─────────────────────────────────────┤
│ + TranscribeAsync(audio): Task      │
│ + TranslateAsync(text): Task        │
│ + GenerateReportAsync(prompt): Task │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│        IAudioRecorder               │
├─────────────────────────────────────┤
│ + StartRecording(): Task            │
│ + StopRecording(): Task<byte[]>     │
│ + IsRecording: bool                 │
└─────────────────────────────────────┘
              ▲
              │ implements
              │
┌─────────────────────────────────────┐
│        AudioRecorder                │
├─────────────────────────────────────┤
│ - waveIn: WaveInEvent               │
│ - writer: WaveFileWriter            │
│ - settings: AudioSettings           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│    IAudioCaptureService             │
├─────────────────────────────────────┤
│ + StartCapture(): Task              │
│ + StopCapture(): Task               │
│ + OnAudioData: EventHandler         │
└─────────────────────────────────────┘
              ▲
              │ implements
              │
        ┌─────┴─────┐
        │           │
┌───────┴──────┐  ┌─┴──────────────────┐
│ Microphone   │  │ StereoMixCapture   │
│ Capture      │  │ Service            │
│ Service      │  │                    │
└──────────────┘  └────────────────────┘
```

### File Processing

```
┌─────────────────────────────────────┐
│        IFileParser                  │
├─────────────────────────────────────┤
│ + ParseAsync(filePath): Task<string>│
│ + CanParse(extension): bool         │
└─────────────────────────────────────┘
              ▲
              │ implements
              │
        ┌─────┴─────┐
        │           │
┌───────┴──────┐  ┌─┴──────────────┐
│ TextFile     │  │ WordFile       │
│ Parser       │  │ Parser         │
└──────────────┘  └────────────────┘

┌─────────────────────────────────────┐
│      FileParserFactory              │
├─────────────────────────────────────┤
│ + CreateParser(extension): IFileParser│
└─────────────────────────────────────┘
```

---

## Диаграмма классов: Presentation Layer

### ViewModels

```
┌─────────────────────────────────────┐
│        BaseViewModel                │
├─────────────────────────────────────┤
│ + PropertyChanged: event            │
│ + SetProperty<T>(ref, value)        │
└─────────────────────────────────────┘
              ▲
              │ inherits
              │
┌─────────────────────────────────────┐
│        MainViewModel                │
├─────────────────────────────────────┤
│ - meetingService: IMeetingService   │
│ - translationService: ITranslation  │
│ - windowService: IWindowService     │
│ + CurrentMeeting: Meeting           │
│ + IsRecording: bool                 │
│ + SelectedLanguage: Language        │
│ + StartMeetingCommand: ICommand     │
│ + StopMeetingCommand: ICommand      │
│ + LoadTemplateCommand: ICommand     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│     TranslationViewModel            │
├─────────────────────────────────────┤
│ - translationService: ITranslation  │
│ + OriginalText: string              │
│ + TranslatedText: string            │
│ + IsListening: bool                 │
│ + ListenToInterlocutorCommand       │
│ + ListenToUsCommand                 │
└─────────────────────────────────────┘
```

### Services

```
┌─────────────────────────────────────┐
│       IWindowService                │
├─────────────────────────────────────┤
│ + SetOpacity(value: double)         │
│ + SetAlwaysOnTop(enabled: bool)     │
│ + HideWindow()                      │
│ + ShowWindow()                      │
└─────────────────────────────────────┘
              ▲
              │ implements
              │
┌─────────────────────────────────────┐
│        WindowService                │
├─────────────────────────────────────┤
│ - mainWindow: Window                │
│ + SetOpacity(value: double)         │
│ + SetAlwaysOnTop(enabled: bool)     │
│ + HideWindow()                      │
└─────────────────────────────────────┘
```

---

## Последовательность операций

### Сценарий 1: Запись совещания

```
User          MainViewModel    StartMeetingUseCase    MeetingService    AudioRecorder
  │                 │                  │                    │                 │
  │──Start Click───>│                  │                    │                 │
  │                 │──ExecuteAsync()─>│                    │                 │
  │                 │                  │──StartAsync()─────>│                 │
  │                 │                  │                    │──Start()───────>│
  │                 │                  │                    │<──Recording─────│
  │                 │                  │<──Meeting──────────│                 │
  │                 │<──Meeting────────│                    │                 │
  │<──UI Updated────│                  │                    │                 │
```

### Сценарий 2: Перевод в реальном времени

```
User    TranslationVM    ListenUseCase    AudioCapture    OpenAI    TranslationService
  │           │               │                │            │              │
  │──Click───>│               │                │            │              │
  │           │──Execute()───>│                │            │              │
  │           │               │──Start()──────>│            │              │
  │           │               │                │──Audio────>│              │
  │           │               │                │            │──Transcribe─>│
  │           │               │                │            │<──Text───────│
  │           │               │                │            │              │──Translate()─>│
  │           │               │                │            │              │<──Result──────│
  │           │<──Result──────│                │            │              │
  │<──UI──────│               │                │            │              │
```

---

## Зависимости между модулями

### Dependency Injection Container Setup

```csharp
// Пример регистрации зависимостей
services.AddSingleton<IOpenAIClient, OpenAIClient>();
services.AddSingleton<IAudioRecorder, AudioRecorder>();
services.AddSingleton<IMeetingService, MeetingService>();
services.AddSingleton<ITranslationService, TranslationService>();
services.AddScoped<IMeetingRepository, MeetingRepository>();
services.AddScoped<IRecordingRepository, RecordingRepository>();
services.AddTransient<IFileParser, TextFileParser>();
services.AddTransient<IFileParser, WordFileParser>();
services.AddSingleton<IWindowService, WindowService>();
services.AddTransient<MainViewModel>();
services.AddTransient<TranslationViewModel>();
```

---

## Модульность и расширяемость

### Добавление нового провайдера AI

1. Создать интерфейс `IAIService` в Domain
2. Реализовать в Infrastructure (например, `AzureAIService`)
3. Зарегистрировать в DI контейнере
4. Использовать через абстракцию в Use Cases

### Добавление нового формата файла

1. Реализовать `IFileParser` (например, `PdfFileParser`)
2. Зарегистрировать в Factory
3. Автоматически поддерживается в Use Cases

### Добавление нового источника аудио

1. Реализовать `IAudioCaptureService` (например, `BluetoothCaptureService`)
2. Зарегистрировать в DI
3. Использовать в Translation Use Cases

---

## Тестируемость

Все зависимости через интерфейсы позволяют:
- Мокировать внешние сервисы
- Тестировать Use Cases изолированно
- Тестировать ViewModels с моками сервисов
- Интеграционные тесты с реальными реализациями

