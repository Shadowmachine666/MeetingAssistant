# Архитектура приложения MeetingAssistant

## Общая концепция

Приложение построено на принципах **Clean Architecture** с разделением на слои и использованием паттернов **SOLID**. Архитектура обеспечивает расширяемость, тестируемость и поддержку.

---

## Структура слоев

### 1. Domain Layer (Доменный слой)
**Назначение**: Бизнес-логика и сущности, независимые от внешних зависимостей.

#### 1.1. Entities (Сущности)
```
Domain/Entities/
├── Meeting.cs                    # Сущность совещания
├── MeetingRecording.cs           # Запись совещания
├── MeetingReport.cs              # Отчет о совещании
├── TranslationRequest.cs         # Запрос на перевод
├── TranslationResult.cs          # Результат перевода
├── ExampleReportTemplate.cs      # Шаблон примера отчета
└── AudioSource.cs                # Источник аудио (микрофон/стерео микс)
```

**Описание сущностей:**
- `Meeting`: ID, дата/время начала/окончания, статус, участники
- `MeetingRecording`: путь к файлу, длительность, метаданные
- `MeetingReport`: содержимое, язык, дата создания, шаблон
- `TranslationRequest`: исходный текст, исходный язык, целевой язык
- `TranslationResult`: оригинальный текст, переведенный текст, язык
- `ExampleReportTemplate`: путь к файлу, содержимое, структура
- `AudioSource`: тип (микрофон/стерео микс), устройство, настройки

#### 1.2. Enums
```
Domain/Enums/
├── Language.cs                   # Языки: Russian, Polish, English
├── MeetingStatus.cs              # Статусы: NotStarted, Recording, Stopped, Processing, Completed
├── AudioSourceType.cs            # Типы: Microphone, StereoMix
├── TranslationStatus.cs          # Статусы: Idle, Listening, Processing, Completed, Error
└── WindowState.cs                # Состояния окна: Normal, Hidden, AlwaysOnTop
```

#### 1.3. Value Objects
```
Domain/ValueObjects/
├── AudioSettings.cs              # Настройки аудио (sample rate, channels, etc.)
├── WindowSettings.cs             # Настройки окна (прозрачность, всегда поверх)
└── ApiConfiguration.cs           # Конфигурация API (ключ, endpoint, модель)
```

#### 1.4. Interfaces (Repository Pattern)
```
Domain/Interfaces/
├── IMeetingRepository.cs         # Репозиторий для работы с совещаниями
├── IRecordingRepository.cs       # Репозиторий для работы с записями
├── IReportRepository.cs          # Репозиторий для работы с отчетами
├── ITemplateRepository.cs        # Репозиторий для работы с шаблонами
└── ITranslationRepository.cs     # Репозиторий для работы с переводами
```

---

### 2. Application Layer (Слой приложения)
**Назначение**: Координация бизнес-логики, Use Cases, DTOs.

#### 2.1. Use Cases (Сценарии использования)
```
Application/UseCases/
├── Meeting/
│   ├── StartMeetingUseCase.cs
│   ├── StopMeetingUseCase.cs
│   ├── ProcessMeetingRecordingUseCase.cs
│   └── GenerateMeetingReportUseCase.cs
├── Translation/
│   ├── ListenToInterlocutorUseCase.cs
│   ├── ListenToUsUseCase.cs
│   └── TranslateTextUseCase.cs
├── Template/
│   ├── LoadExampleTemplateUseCase.cs
│   └── ValidateTemplateUseCase.cs
└── Settings/
    ├── UpdateWindowSettingsUseCase.cs
    └── UpdateAudioSettingsUseCase.cs
```

#### 2.2. DTOs (Data Transfer Objects)
```
Application/DTOs/
├── MeetingDTO.cs
├── RecordingDTO.cs
├── ReportDTO.cs
├── TranslationDTO.cs
└── SettingsDTO.cs
```

#### 2.3. Services (Application Services)
```
Application/Services/
├── IMeetingService.cs            # Сервис управления совещаниями
├── ITranslationService.cs        # Сервис переводов
├── IReportGenerationService.cs   # Сервис генерации отчетов
└── IAudioProcessingService.cs    # Сервис обработки аудио
```

---

### 3. Infrastructure Layer (Слой инфраструктуры)
**Назначение**: Реализация внешних зависимостей (API, файловая система, аудио).

#### 3.1. External Services
```
Infrastructure/ExternalServices/
├── OpenAI/
│   ├── IOpenAIClient.cs
│   ├── OpenAIClient.cs           # Клиент для OpenAI API
│   ├── OpenAITranscriptionService.cs
│   ├── OpenAITranslationService.cs
│   └── OpenAIReportGenerationService.cs
└── Audio/
    ├── IAudioRecorder.cs
    ├── AudioRecorder.cs          # Запись аудио
    ├── IAudioCaptureService.cs
    ├── MicrophoneCaptureService.cs
    ├── StereoMixCaptureService.cs
    └── AudioFormatConverter.cs
```

#### 3.2. Repositories (Реализация)
```
Infrastructure/Repositories/
├── MeetingRepository.cs
├── RecordingRepository.cs
├── ReportRepository.cs
├── TemplateRepository.cs
└── TranslationRepository.cs
```

#### 3.3. File System
```
Infrastructure/FileSystem/
├── IFileService.cs
├── FileService.cs                # Работа с файлами
├── IFileParser.cs
├── TextFileParser.cs             # Парсинг .txt
└── WordFileParser.cs             # Парсинг .docx (через библиотеку)
```

#### 3.4. Storage
```
Infrastructure/Storage/
├── IStorageService.cs
├── LocalStorageService.cs        # Локальное хранилище
└── StoragePaths.cs               # Пути к папкам (Recordings, Reports, Templates)
```

#### 3.5. Configuration
```
Infrastructure/Configuration/
├── IConfigurationService.cs
├── ConfigurationService.cs       # Работа с настройками (JSON/XML)
└── AppSettings.cs                # Модель настроек
```

---

### 4. Presentation Layer (Слой представления)
**Назначение**: UI, ViewModels, пользовательский интерфейс.

#### 4.1. ViewModels (MVVM Pattern)
```
Presentation/ViewModels/
├── MainViewModel.cs              # Главная ViewModel
├── MeetingViewModel.cs           # Управление совещанием
├── TranslationViewModel.cs       # Управление переводами
├── ReportViewModel.cs            # Управление отчетами
├── SettingsViewModel.cs          # Настройки
└── BaseViewModel.cs              # Базовый класс (INotifyPropertyChanged)
```

#### 4.2. Views (UI)
```
Presentation/Views/
├── MainWindow.xaml               # Главное окно
├── MainWindow.xaml.cs
├── Controls/
│   ├── OriginalTextControl.xaml  # Окно "Текст оригинала"
│   ├── TranslatedTextControl.xaml # Окно "Текст перевода"
│   ├── RecordingControl.xaml     # Панель записи
│   └── TranslationControl.xaml   # Панель переводов
└── Dialogs/
    ├── LoadTemplateDialog.xaml
    └── SettingsDialog.xaml
```

#### 4.3. Services (Presentation Services)
```
Presentation/Services/
├── IDialogService.cs             # Сервис диалогов
├── DialogService.cs
├── IWindowService.cs             # Управление окнами
├── WindowService.cs              # Прозрачность, всегда поверх, скрытие
└── INotificationService.cs       # Уведомления
```

#### 4.4. Converters (Value Converters)
```
Presentation/Converters/
├── LanguageToStringConverter.cs
├── StatusToColorConverter.cs
└── BooleanToVisibilityConverter.cs
```

#### 4.5. Commands
```
Presentation/Commands/
├── RelayCommand.cs               # Реализация ICommand
└── AsyncRelayCommand.cs          # Асинхронная команда
```

---

### 5. Core/Common Layer (Общий слой)
**Назначение**: Общие утилиты, расширения, базовые классы.

```
Core/
├── Extensions/
│   ├── StringExtensions.cs
│   ├── DateTimeExtensions.cs
│   └── EnumExtensions.cs
├── Helpers/
│   ├── AudioHelper.cs
│   ├── FileHelper.cs
│   └── LanguageHelper.cs
├── Exceptions/
│   ├── MeetingException.cs
│   ├── TranslationException.cs
│   └── ApiException.cs
└── Logging/
    ├── ILogger.cs
    └── FileLogger.cs
```

---

## Паттерны проектирования

### 1. Repository Pattern
- Абстракция доступа к данным
- Легкая замена источников данных

### 2. Dependency Injection
- Внедрение зависимостей через конструктор
- Использование DI контейнера (например, Microsoft.Extensions.DependencyInjection)

### 3. MVVM (Model-View-ViewModel)
- Разделение UI и бизнес-логики
- Data Binding для реактивности

### 4. Command Pattern
- RelayCommand для обработки действий пользователя
- AsyncRelayCommand для асинхронных операций

### 5. Strategy Pattern
- Разные стратегии парсинга файлов (Text, Word)
- Разные стратегии захвата аудио (Microphone, StereoMix)

### 6. Observer Pattern
- INotifyPropertyChanged для обновления UI
- События для уведомлений

### 7. Factory Pattern
- Создание парсеров файлов
- Создание аудио-сервисов

---

## Технологический стек

### UI Framework
- **WPF** (Windows Presentation Foundation) - для десктопного приложения Windows
- **Material Design** или **Modern UI** - для современного интерфейса

### Audio Processing
- **NAudio** - для работы с аудио (запись, захват с микрофона/стерео микса)
- **System.Speech** или **Azure Speech SDK** - для распознавания речи (опционально)

### API Integration
- **OpenAI .NET SDK** или **HttpClient** - для работы с OpenAI API
- **Newtonsoft.Json** или **System.Text.Json** - для сериализации

### File Processing
- **DocumentFormat.OpenXml** - для работы с Word документами (.docx)
- **System.IO** - для работы с текстовыми файлами

### Dependency Injection
- **Microsoft.Extensions.DependencyInjection** - DI контейнер

### Configuration
- **Microsoft.Extensions.Configuration** - для работы с настройками

### Logging
- **Serilog** или **NLog** - для логирования

---

## Структура проекта (Solution)

```
MeetingAssistant.sln
├── MeetingAssistant.Domain          # Domain Layer
├── MeetingAssistant.Application     # Application Layer
├── MeetingAssistant.Infrastructure  # Infrastructure Layer
├── MeetingAssistant.Presentation    # Presentation Layer (WPF)
├── MeetingAssistant.Core            # Core/Common
└── MeetingAssistant.Tests           # Unit Tests (опционально)
    ├── Domain.Tests
    ├── Application.Tests
    └── Infrastructure.Tests
```

---

## Потоки данных

### 1. Запись и обработка совещания
```
User → MainViewModel → StartMeetingUseCase → MeetingService
     → AudioRecorder → RecordingRepository → Storage
     
User → StopMeetingUseCase → ProcessMeetingRecordingUseCase
     → OpenAIClient → GenerateMeetingReportUseCase
     → ReportRepository → UI Update
```

### 2. Перевод в реальном времени
```
User → TranslationViewModel → ListenToInterlocutorUseCase
     → StereoMixCaptureService → AudioRecorder → OpenAI Transcription
     → TranslateTextUseCase → OpenAI Translation → UI Update
```

### 3. Загрузка шаблона
```
User → LoadTemplateDialog → LoadExampleTemplateUseCase
     → FileService → FileParser → TemplateRepository
     → Validation → UI Update
```

---

## Расширяемость

### Легко добавить:
1. **Новые языки** - добавить в enum Language
2. **Новые форматы файлов** - реализовать IFileParser
3. **Новые источники аудио** - реализовать IAudioCaptureService
4. **Новые провайдеры AI** - реализовать интерфейсы AI сервисов
5. **Новые типы отчетов** - расширить ReportGenerationService
6. **Экспорт отчетов** - добавить IExportService с реализациями (PDF, HTML, etc.)
7. **История совещаний** - расширить MeetingRepository
8. **Настройки пользователя** - расширить SettingsService

---

## Принципы SOLID

### Single Responsibility Principle (SRP)
- Каждый класс отвечает за одну задачу
- Разделение на слои обеспечивает четкие границы ответственности

### Open/Closed Principle (OCP)
- Расширение через интерфейсы (IFileParser, IAudioCaptureService)
- Закрыто для модификации, открыто для расширения

### Liskov Substitution Principle (LSP)
- Все реализации интерфейсов взаимозаменяемы
- Базовые классы могут быть заменены наследниками

### Interface Segregation Principle (ISP)
- Интерфейсы разделены по функциональности
- Клиенты зависят только от нужных интерфейсов

### Dependency Inversion Principle (DIP)
- Зависимости направлены на абстракции (интерфейсы)
- Высокоуровневые модули не зависят от низкоуровневых

---

## Конфигурация и настройки

### AppSettings.json
```json
{
  "OpenAI": {
    "ApiKey": "",
    "BaseUrl": "https://api.openai.com/v1",
    "Model": "gpt-4",
    "TranscriptionModel": "whisper-1"
  },
  "Audio": {
    "SampleRate": 44100,
    "Channels": 2,
    "BitDepth": 16,
    "DefaultMicrophone": "",
    "DefaultStereoMix": ""
  },
  "Storage": {
    "RecordingsPath": "./Recordings",
    "ReportsPath": "./Reports",
    "TemplatesPath": "./Templates"
  },
  "Window": {
    "Opacity": 0.9,
    "AlwaysOnTop": false,
    "DefaultLanguage": "Russian"
  }
}
```

---

## Обработка ошибок

### Иерархия исключений
- `MeetingException` - базовое исключение для совещаний
- `TranslationException` - исключения переводов
- `ApiException` - исключения API
- `AudioException` - исключения аудио
- `FileException` - исключения файлов

### Стратегия обработки
- Логирование всех исключений
- Пользовательские сообщения об ошибках
- Graceful degradation (приложение продолжает работать при частичных сбоях)

---

## Производительность

### Оптимизации
1. **Асинхронность** - все I/O операции асинхронные
2. **Буферизация аудио** - потоковая обработка для реального времени
3. **Кэширование** - кэш шаблонов и настроек
4. **Ленивая загрузка** - загрузка компонентов по требованию

---

## Безопасность

1. **Хранение API ключей** - в зашифрованном виде или через Windows Credential Manager
2. **Валидация файлов** - проверка загружаемых файлов
3. **Ограничение доступа** - права доступа к файлам записей

---

## Тестирование (будущее)

### Unit Tests
- Тестирование Use Cases
- Тестирование сервисов
- Тестирование репозиториев (с моками)

### Integration Tests
- Тестирование интеграции с OpenAI API (с моками)
- Тестирование работы с файловой системой

### UI Tests
- Тестирование ViewModels
- Тестирование команд и привязок

---

## Следующие шаги

После утверждения архитектуры:
1. Создание структуры проектов в Solution
2. Настройка зависимостей (NuGet пакеты)
3. Реализация базовых классов и интерфейсов
4. Поэтапная реализация функциональности

