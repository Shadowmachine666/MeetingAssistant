# Анализ требований к API ключам OpenAI


## Сценарии использования API

### 1. Транскрипция записи совещания
- **Частота**: 1 запрос после окончания каждого совещания
- **Тип**: Whisper API (аудио → текст)
- **Длительность**: Зависит от длины записи (может быть долгим)
- **Приоритет**: Высокий (основная функция)

### 2. Перевод в реальном времени (собеседник)
- **Частота**: По требованию (кнопка "Выслушать собеседника")
- **Тип**: Whisper API (аудио → текст) + Chat API (перевод)
- **Длительность**: Короткие запросы (5-30 секунд аудио)
- **Приоритет**: Высокий (работа в реальном времени)

### 3. Перевод в реальном времени (мы)
- **Частота**: По требованию (кнопка "Выслушать нас")
- **Тип**: Whisper API (аудио → текст) + Chat API (перевод)
- **Длительность**: Короткие запросы (5-30 секунд аудио)
- **Приоритет**: Высокий (работа в реальном времени)

### 4. Генерация отчета
- **Частота**: 1 запрос после транскрипции
- **Тип**: Chat API (GPT-4)
- **Длительность**: Средняя (зависит от длины транскрипции)
- **Приоритет**: Средний (можно отложить)

## Проблемные сценарии

### Сценарий 1: Параллельные переводы
- Пользователь нажимает "Выслушать собеседника" и "Выслушать нас" одновременно
- Два параллельных запроса к Whisper API
- **Риск**: Rate limit превышен

### Сценарий 2: Перевод во время обработки записи
- Совещание закончилось, идет транскрипция (долгий запрос)
- Пользователь хочет перевести что-то еще
- **Риск**: Rate limit или очередь запросов

### Сценарий 3: Частые переводы
- Пользователь активно использует переводы (каждые 10-20 секунд)
- **Риск**: Rate limit (3 RPM для free, 200 RPM для paid)

## Rate Limits OpenAI

### Free Tier
- **Requests per minute (RPM)**: 3
- **Tokens per minute (TPM)**: 40,000
- **Requests per day (RPD)**: 200

### Paid Tier (Tier 1)
- **RPM**: 200
- **TPM**: 60,000
- **RPD**: Неограничено

## Рекомендации

### Вариант 1: Один API ключ (минимальный)
**Подходит для**: Личное использование, редкие совещания
- ✅ Достаточно для базовой функциональности
- ❌ Риск rate limits при активном использовании
- ✅ Простая настройка

**Реализация**:
- Очередь запросов с приоритетами
- Retry механизм с экспоненциальной задержкой
- Кэширование результатов

### Вариант 2: Два API ключа (рекомендуемый)
**Подходит для**: Регулярное использование, активные переводы
- ✅ Распределение нагрузки между ключами
- ✅ Параллельные переводы без проблем
- ✅ Резервный ключ при проблемах

**Реализация**:
- Ротация ключей для переводов
- Один ключ для транскрипции, другой для переводов
- Автоматическое переключение при rate limit

### Вариант 3: Три+ API ключа (оптимальный)
**Подходит для**: Профессиональное использование, частые совещания
- ✅ Максимальная надежность
- ✅ Параллельная обработка без ограничений
- ✅ Высокая доступность

**Реализация**:
- Пул ключей с балансировкой нагрузки
- Мониторинг использования каждого ключа
- Автоматическое переключение

## Итоговая рекомендация

**Для начала**: 1 ключ с правильной обработкой rate limits
**Для продакшена**: 2-3 ключа с ротацией

Архитектура должна поддерживать:
1. Конфигурацию нескольких ключей через .env
2. Ротацию ключей
3. Обработку rate limits
4. Очередь запросов с приоритетами
5. Retry механизм

## Структура .env файла

```env
# OpenAI API Keys (можно указать несколько для ротации)
OPENAI_API_KEY_1=sk-...
OPENAI_API_KEY_2=sk-...  # опционально
OPENAI_API_KEY_3=sk-...  # опционально

# OpenAI Configuration
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4
OPENAI_TRANSCRIPTION_MODEL=whisper-1
OPENAI_MAX_TOKENS=4000
OPENAI_TEMPERATURE=0.7

# Rate Limiting
OPENAI_RPM_LIMIT=200
OPENAI_RETRY_ATTEMPTS=3
OPENAI_RETRY_DELAY_MS=1000
```
